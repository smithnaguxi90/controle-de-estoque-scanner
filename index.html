<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>StockFlow Pro - Gestão Inteligente</title>

    <!-- Bibliotecas Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Biblioteca de Leitura de QR/Barcode via Câmera -->
    <script
      src="https://unpkg.com/html5-qrcode"
      type="text/javascript"
    ></script>

    <!-- Configuração Tailwind -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#4F46E5", // Indigo 600
              secondary: "#10B981", // Emerald 500
              danger: "#EF4444", // Red 500
              surface: "#F8FAFC", // Slate 50
            },
            fontFamily: {
              sans: ["Inter", "sans-serif"],
            },
          },
        },
      };
    </script>

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap");

      body {
        font-family: "Inter", sans-serif;
      }

      /* Animações */
      @keyframes slideInRight {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .toast-enter {
        animation: slideInRight 0.3s ease-out forwards;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(5px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .fade-in {
        animation: fadeIn 0.3s ease-out forwards;
      }

      /* Scrollbar Personalizada */
      .custom-scroll::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      .custom-scroll::-webkit-scrollbar-track {
        background: transparent;
      }
      .custom-scroll::-webkit-scrollbar-thumb {
        background-color: #cbd5e1;
        border-radius: 20px;
      }
      .custom-scroll::-webkit-scrollbar-thumb:hover {
        background-color: #94a3b8;
      }

      /* Utilitários */
      .glass-panel {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(226, 232, 240, 0.8);
      }

      /* Estilos específicos para o leitor de câmera */
      #reader__scan_region {
        background: white;
      }
      #reader video {
        object-fit: cover;
        border-radius: 12px;
      }
    </style>
  </head>
  <body
    class="bg-surface text-slate-800 h-screen overflow-hidden flex flex-col md:flex-row"
  >
    <!-- Sidebar Navegação -->
    <aside
      class="fixed bottom-0 md:relative w-full md:w-72 bg-white md:border-r border-slate-200 z-40 flex md:flex-col justify-between shadow-lg md:shadow-none h-16 md:h-full order-2 md:order-1 transition-all"
    >
      <!-- Logo -->
      <div class="hidden md:flex items-center gap-3 p-8">
        <div class="bg-primary/10 p-2.5 rounded-xl text-primary">
          <i data-lucide="boxes" class="w-7 h-7"></i>
        </div>
        <div>
          <h1 class="text-xl font-bold tracking-tight text-slate-900">
            StockFlow
          </h1>
          <p class="text-xs text-slate-500 font-medium tracking-wide">
            PRO EDITION
          </p>
        </div>
      </div>

      <!-- Menu -->
      <nav
        class="flex md:flex-col w-full md:w-auto justify-around md:justify-start px-2 md:px-4 gap-1 md:gap-2"
      >
        <button
          onclick="app.navigate('dashboard')"
          id="nav-dashboard"
          class="nav-item group flex items-center gap-3 p-3 md:px-4 md:py-3.5 rounded-xl transition-all hover:bg-slate-50"
        >
          <i
            data-lucide="layout-grid"
            class="w-5 h-5 text-slate-400 group-hover:text-primary transition-colors"
          ></i>
          <span
            class="font-medium text-slate-600 group-hover:text-slate-900 hidden md:block"
            >Dashboard</span
          >
        </button>

        <button
          onclick="app.navigate('scanner')"
          id="nav-scanner"
          class="nav-item group flex items-center gap-3 p-3 md:px-4 md:py-3.5 rounded-xl transition-all hover:bg-slate-50"
        >
          <i
            data-lucide="scan-barcode"
            class="w-5 h-5 text-slate-400 group-hover:text-primary transition-colors"
          ></i>
          <span
            class="font-medium text-slate-600 group-hover:text-slate-900 hidden md:block"
            >Leitor de Código</span
          >
        </button>

        <button
          onclick="app.navigate('inventory')"
          id="nav-inventory"
          class="nav-item group flex items-center gap-3 p-3 md:px-4 md:py-3.5 rounded-xl transition-all hover:bg-slate-50"
        >
          <i
            data-lucide="package-search"
            class="w-5 h-5 text-slate-400 group-hover:text-primary transition-colors"
          ></i>
          <span
            class="font-medium text-slate-600 group-hover:text-slate-900 hidden md:block"
            >Inventário</span
          >
        </button>
      </nav>

      <!-- User Profile (Fake) -->
      <div
        class="hidden md:flex p-4 m-4 bg-slate-50 rounded-xl items-center gap-3 border border-slate-100"
      >
        <div
          class="w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center font-bold"
        >
          AD
        </div>
        <div class="flex-1 min-w-0">
          <p class="text-sm font-semibold truncate">Admin User</p>
          <p class="text-xs text-slate-500 truncate">Gerente de Estoque</p>
        </div>
        <button
          onclick="app.resetData()"
          class="text-slate-400 hover:text-danger"
          title="Resetar Dados"
        >
          <i data-lucide="log-out" class="w-4 h-4"></i>
        </button>
      </div>
    </aside>

    <!-- Área Principal -->
    <main
      class="flex-1 p-4 md:p-8 pb-24 md:pb-8 overflow-y-auto overflow-x-hidden order-1 md:order-2 relative bg-slate-50/50 custom-scroll"
    >
      <!-- Header Superior -->
      <header class="flex justify-between items-end mb-8 fade-in">
        <div>
          <h2
            id="page-title"
            class="text-3xl font-bold text-slate-900 tracking-tight"
          >
            Visão Geral
          </h2>
          <p
            id="current-date"
            class="text-slate-500 text-sm mt-1 font-medium"
          ></p>
        </div>
        <div class="flex gap-3">
          <button
            onclick="app.exportCSV()"
            class="hidden md:flex items-center gap-2 bg-white border border-slate-200 text-slate-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-50 transition-colors shadow-sm"
          >
            <i data-lucide="download" class="w-4 h-4"></i>
            Exportar CSV
          </button>
        </div>
      </header>

      <!-- Conteúdo Dinâmico -->
      <div id="app-content" class="relative min-h-[500px]">
        <!-- Injetado via JS -->
      </div>
    </main>

    <!-- Container de Toasts -->
    <div
      id="toast-container"
      class="fixed top-4 right-4 z-50 flex flex-col gap-2 pointer-events-none"
    ></div>

    <!-- Modal Câmera -->
    <div
      id="modal-camera"
      class="hidden fixed inset-0 z-[60] bg-black/90 backdrop-blur-sm items-center justify-center p-4 transition-opacity duration-300"
    >
      <div
        class="bg-white rounded-2xl w-full max-w-md shadow-2xl overflow-hidden flex flex-col max-h-[90vh]"
      >
        <div
          class="p-4 bg-slate-900 text-white flex justify-between items-center"
        >
          <h3 class="font-bold flex items-center gap-2">
            <i data-lucide="camera" class="w-5 h-5"></i>
            Escanear Código
          </h3>
          <button
            onclick="app.stopCamera()"
            class="p-1 hover:bg-slate-700 rounded-full"
          >
            <i data-lucide="x" class="w-6 h-6"></i>
          </button>
        </div>
        <div
          class="p-4 bg-black flex-1 flex items-center justify-center relative overflow-hidden"
        >
          <div id="reader" class="w-full h-full"></div>
          <!-- Overlay de mira -->
          <div
            class="absolute inset-0 pointer-events-none border-2 border-primary/50 opacity-50 rounded-lg m-12"
          ></div>
          <div
            class="absolute inset-0 pointer-events-none flex items-center justify-center"
          >
            <div
              class="w-64 h-1 bg-red-500/50 shadow-[0_0_10px_rgba(239,68,68,0.8)]"
            ></div>
          </div>
        </div>
        <div class="p-4 bg-slate-50 text-center text-xs text-slate-500">
          Aponte a câmera para um código de barras ou QR Code.
        </div>
      </div>
    </div>

    <!-- Modal Produto (Novo / Editar) -->
    <div
      id="modal-add"
      class="hidden fixed inset-0 z-50 bg-slate-900/40 backdrop-blur-sm items-center justify-center p-4 transition-opacity duration-300"
    >
      <div
        class="bg-white rounded-2xl w-full max-w-lg shadow-2xl transform transition-all scale-95 opacity-0"
        id="modal-content"
      >
        <div
          class="flex justify-between items-center p-6 border-b border-slate-100"
        >
          <h3 id="modal-title" class="text-lg font-bold text-slate-800">
            Novo Produto
          </h3>
          <button
            onclick="app.toggleModal(false)"
            class="text-slate-400 hover:text-slate-600 p-1 rounded-full hover:bg-slate-100 transition-colors"
          >
            <i data-lucide="x" class="w-6 h-6"></i>
          </button>
        </div>
        <form id="form-add" class="p-6 space-y-5">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
            <div class="md:col-span-2">
              <label
                class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1.5"
                >Código de Barras</label
              >
              <div class="flex gap-2">
                <input
                  type="text"
                  id="new-barcode"
                  required
                  class="flex-1 px-4 py-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none font-mono text-sm bg-slate-50 transition-all"
                  placeholder="Escaneie ou digite..."
                />
                <button
                  type="button"
                  onclick="app.openCameraForInput()"
                  class="bg-slate-100 px-3 rounded-lg text-slate-600 hover:bg-slate-200 hover:text-slate-900 transition-colors"
                  title="Ler com Câmera"
                >
                  <i data-lucide="camera" class="w-5 h-5"></i>
                </button>
                <button
                  type="button"
                  onclick="app.generateRandomBarcode()"
                  class="bg-slate-100 px-3 rounded-lg text-slate-600 hover:bg-slate-200 hover:text-slate-900 transition-colors"
                  title="Gerar Aleatório"
                >
                  <i data-lucide="wand-2" class="w-5 h-5"></i>
                </button>
              </div>
            </div>

            <div class="md:col-span-2">
              <label
                class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1.5"
                >Nome do Produto</label
              >
              <input
                type="text"
                id="new-name"
                required
                class="w-full px-4 py-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all"
                placeholder="Ex: Monitor UltraWide"
              />
            </div>

            <div>
              <label
                class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1.5"
                >Categoria</label
              >
              <select
                id="new-category"
                class="w-full px-4 py-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none bg-white transition-all"
              >
                <option value="Geral">Geral</option>
                <option value="Eletrônicos">Eletrônicos</option>
                <option value="Periféricos">Periféricos</option>
                <option value="Cabos">Cabos</option>
                <option value="Móveis">Móveis</option>
              </select>
            </div>
            <div>
              <label
                class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1.5"
                >Preço Unitário (R$)</label
              >
              <input
                type="number"
                id="new-price"
                step="0.01"
                min="0"
                required
                class="w-full px-4 py-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all"
              />
            </div>

            <div>
              <label
                class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1.5"
                >Estoque</label
              >
              <input
                type="number"
                id="new-quantity"
                min="0"
                required
                class="w-full px-4 py-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all"
              />
            </div>
            <div>
              <label
                class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1.5"
                >Estoque Mínimo</label
              >
              <input
                type="number"
                id="new-minStock"
                min="1"
                value="5"
                required
                class="w-full px-4 py-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all"
              />
            </div>
          </div>

          <div class="pt-2">
            <button
              type="submit"
              class="w-full bg-primary hover:bg-indigo-700 text-white font-semibold py-3.5 rounded-xl shadow-lg shadow-primary/30 transition-all active:scale-[0.98] flex justify-center items-center gap-2"
            >
              <i data-lucide="save" class="w-5 h-5"></i>
              Salvar Produto
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Lógica da Aplicação -->
    <script>
      class StockSystem {
        constructor() {
          // Estado Padrão
          this.defaultState = {
            inventory: [
              {
                id: 1709234,
                barcode: "7891000100",
                name: "Teclado Mecânico RGB",
                quantity: 15,
                price: 250.0,
                minStock: 5,
                category: "Periféricos",
              },
              {
                id: 1709235,
                barcode: "7891000200",
                name: "Mouse Gamer DPI",
                quantity: 3,
                price: 120.0,
                minStock: 10,
                category: "Periféricos",
              },
              {
                id: 1709236,
                barcode: "7891000300",
                name: "Monitor 24pol LED",
                quantity: 8,
                price: 899.0,
                minStock: 3,
                category: "Eletrônicos",
              },
            ],
            logs: [],
          };

          // Carregar ou Iniciar Estado
          this.loadData();

          this.activeTab = "dashboard";
          this.scanMode = "in";
          this.searchTerm = "";
          this.chartInstance = null;
          this.editingId = null;
          this.html5QrcodeScanner = null;
          this.cameraTargetInput = null; // Para saber onde preencher o código lido (scanner principal ou modal de cadastro)

          // Bindings
          this.handleScanSubmit = this.handleScanSubmit.bind(this);
          this.handleSaveItem = this.handleSaveItem.bind(this);
        }

        // --- Gerenciamento de Dados (Persistência) ---
        loadData() {
          const saved = localStorage.getItem("stockFlowData");
          if (saved) {
            const parsed = JSON.parse(saved);
            this.inventory = parsed.inventory || [];
            this.logs = parsed.logs || [];
          } else {
            this.inventory = [...this.defaultState.inventory];
            this.logs = [...this.defaultState.logs];
          }
        }

        saveData() {
          localStorage.setItem(
            "stockFlowData",
            JSON.stringify({
              inventory: this.inventory,
              logs: this.logs,
            }),
          );
        }

        resetData() {
          if (
            confirm(
              "Tem certeza? Isso apagará todos os dados e restaurará o exemplo.",
            )
          ) {
            localStorage.removeItem("stockFlowData");
            location.reload();
          }
        }

        // --- Inicialização ---
        init() {
          this.updateDateDisplay();
          this.render();
          lucide.createIcons();

          document.addEventListener("keydown", (e) => {
            if (this.activeTab === "scanner") {
              if (e.key === "F5") {
                e.preventDefault();
                this.setScanMode("in");
              }
              if (e.key === "F6") {
                e.preventDefault();
                this.setScanMode("out");
              }
            }
          });
        }

        updateDateDisplay() {
          const dateEl = document.getElementById("current-date");
          if (dateEl) {
            const options = {
              weekday: "long",
              year: "numeric",
              month: "long",
              day: "numeric",
            };
            dateEl.textContent = new Date().toLocaleDateString(
              "pt-BR",
              options,
            );
          }
        }

        navigate(tab) {
          this.activeTab = tab;
          document.querySelectorAll(".nav-item").forEach((el) => {
            const isActive = el.id === `nav-${tab}`;
            el.className = `nav-item group flex items-center gap-3 p-3 md:px-4 md:py-3.5 rounded-xl transition-all ${isActive ? "bg-primary text-white shadow-lg shadow-primary/30" : "hover:bg-slate-50 text-slate-600"}`;

            const icon = el.querySelector("i");
            if (icon)
              icon.className = `w-5 h-5 transition-colors ${isActive ? "text-white" : "text-slate-400 group-hover:text-primary"}`;

            const span = el.querySelector("span");
            if (span)
              span.className = `font-medium hidden md:block ${isActive ? "text-white" : "text-slate-600 group-hover:text-slate-900"}`;
          });

          const titles = {
            dashboard: "Visão Geral",
            scanner: "Central de Leitura",
            inventory: "Gestão de Inventário",
          };
          document.getElementById("page-title").textContent = titles[tab];

          this.render();
        }

        render() {
          const container = document.getElementById("app-content");
          container.style.opacity = "0";
          container.style.transform = "translateY(10px)";

          setTimeout(() => {
            container.innerHTML = "";
            if (this.activeTab === "dashboard") this.renderDashboard(container);
            else if (this.activeTab === "scanner")
              this.renderScanner(container);
            else if (this.activeTab === "inventory")
              this.renderInventory(container);

            lucide.createIcons();

            requestAnimationFrame(() => {
              container.style.transition = "all 0.3s ease-out";
              container.style.opacity = "1";
              container.style.transform = "translateY(0)";
            });
          }, 150);
        }

        // --- Dashboard ---
        renderDashboard(container) {
          const totalStock = this.inventory.reduce(
            (acc, item) => acc + item.quantity,
            0,
          );
          const totalValue = this.inventory.reduce(
            (acc, item) => acc + item.price * item.quantity,
            0,
          );
          const lowStock = this.inventory.filter(
            (item) => item.quantity <= item.minStock,
          );

          container.innerHTML = `
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
                            ${this.createStatCard("Total de Itens", this.inventory.length, "boxes", "text-blue-600", "bg-blue-50", false, "app.navigate('inventory')")}
                            ${this.createStatCard("Estoque Físico", totalStock, "layers", "text-emerald-600", "bg-emerald-50", false, "app.navigate('inventory')")}
                            ${this.createStatCard("Valor Estimado", this.formatCurrency(totalValue), "circle-dollar-sign", "text-indigo-600", "bg-indigo-50", false, "app.navigate('inventory')")}
                            ${this.createStatCard("Reposição", lowStock.length, "alert-octagon", "text-red-600", "bg-red-50", lowStock.length > 0, "app.navigate('inventory')")}
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                                <h3 class="text-lg font-bold text-slate-800 mb-6">Distribuição por Categoria</h3>
                                <div class="h-64 w-full">
                                    <canvas id="stockChart"></canvas>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col">
                                <h3 class="text-lg font-bold text-slate-800 mb-4">Alertas de Estoque</h3>
                                <div class="flex-1 overflow-y-auto custom-scroll pr-2 max-h-[300px]">
                                    ${
                                      lowStock.length === 0
                                        ? '<div class="h-full flex flex-col items-center justify-center text-slate-400 text-sm"><i data-lucide="check-circle" class="w-8 h-8 mb-2 text-emerald-400 opacity-50"></i>Tudo em ordem</div>'
                                        : `<div class="space-y-3">
                                            ${lowStock
                                              .map(
                                                (item) => `
                                                <div onclick="app.navigate('inventory'); app.handleSearch('${item.barcode}')" class="flex items-center p-3 bg-red-50/50 border border-red-100 rounded-xl cursor-pointer hover:bg-red-100 transition-colors">
                                                    <div class="flex-1 min-w-0 mr-2">
                                                        <p class="font-medium text-slate-800 truncate text-sm">${item.name}</p>
                                                        <p class="text-xs text-slate-500">Mín: ${item.minStock}</p>
                                                    </div>
                                                    <div class="bg-white px-2 py-1 rounded-lg border border-red-100 shadow-sm">
                                                        <span class="text-red-600 font-bold text-sm">${item.quantity}</span>
                                                    </div>
                                                </div>
                                            `,
                                              )
                                              .join("")}
                                           </div>`
                                    }
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                            <h3 class="text-lg font-bold text-slate-800 mb-4">Últimas Movimentações</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm">
                                    <thead class="text-xs text-slate-400 uppercase font-semibold border-b border-slate-100">
                                        <tr>
                                            <th class="pb-3 pl-2">Horário</th>
                                            <th class="pb-3">Ação</th>
                                            <th class="pb-3">Produto</th>
                                            <th class="pb-3 text-right pr-2">Qtd</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-50">
                                        ${this.logs
                                          .slice(0, 5)
                                          .map(
                                            (log) => `
                                            <tr class="hover:bg-slate-50 transition-colors">
                                                <td class="py-3 pl-2 text-slate-500 font-mono text-xs">${log.date} ${log.time}</td>
                                                <td class="py-3">
                                                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${
                                                      log.action === "entrada"
                                                        ? "bg-emerald-100 text-emerald-800"
                                                        : log.action === "saida"
                                                          ? "bg-red-100 text-red-800"
                                                          : log.action ===
                                                              "novo"
                                                            ? "bg-blue-100 text-blue-800"
                                                            : log.action ===
                                                                "ajuste"
                                                              ? "bg-amber-100 text-amber-800"
                                                              : "bg-slate-100 text-slate-800"
                                                    }">
                                                        ${log.action.toUpperCase()}
                                                    </span>
                                                </td>
                                                <td class="py-3 text-slate-700 font-medium">${log.itemName}</td>
                                                <td class="py-3 text-right pr-2 font-bold text-slate-600">${log.quantity}</td>
                                            </tr>
                                        `,
                                          )
                                          .join("")}
                                    </tbody>
                                </table>
                                ${this.logs.length === 0 ? '<p class="text-center py-4 text-slate-400 italic">Nenhum registro ainda.</p>' : ""}
                            </div>
                        </div>
                    </div>
                `;
          setTimeout(() => this.initChart(), 50);
        }

        createStatCard(
          title,
          value,
          icon,
          textColor,
          bgColor,
          pulse = false,
          onClick = null,
        ) {
          const cursorClass = onClick
            ? "cursor-pointer hover:scale-[1.02] active:scale-[0.98]"
            : "";
          const clickAttr = onClick ? `onclick="${onClick}"` : "";

          return `
                    <div ${clickAttr} class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition-all relative overflow-hidden group ${cursorClass}">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-slate-500 text-xs font-semibold uppercase tracking-wider mb-1">${title}</p>
                                <h3 class="text-2xl font-bold text-slate-800">${value}</h3>
                            </div>
                            <div class="p-3 rounded-xl ${bgColor} ${textColor} group-hover:scale-110 transition-transform">
                                <i data-lucide="${icon}" class="w-6 h-6"></i>
                            </div>
                        </div>
                        ${pulse ? '<span class="absolute top-3 right-3 flex h-3 w-3"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span></span>' : ""}
                    </div>
                `;
        }

        initChart() {
          const ctx = document.getElementById("stockChart");
          if (!ctx) return;
          const categories = {};
          this.inventory.forEach((item) => {
            categories[item.category] =
              (categories[item.category] || 0) + item.quantity;
          });
          if (this.chartInstance) this.chartInstance.destroy();
          this.chartInstance = new Chart(ctx, {
            type: "bar",
            data: {
              labels: Object.keys(categories),
              datasets: [
                {
                  label: "Quantidade em Estoque",
                  data: Object.values(categories),
                  backgroundColor: "#4F46E5",
                  borderRadius: 6,
                  barThickness: 30,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                y: { beginAtZero: true, grid: { color: "#f1f5f9" } },
                x: { grid: { display: false } },
              },
            },
          });
        }

        // --- Scanner ---
        renderScanner(container) {
          container.innerHTML = `
                    <div class="max-w-3xl mx-auto mt-4">
                        <div class="bg-white rounded-3xl shadow-xl border border-slate-200 overflow-hidden">
                            <div class="flex border-b border-slate-100">
                                <button onclick="app.setScanMode('in')" class="flex-1 py-6 flex flex-col items-center justify-center gap-2 transition-colors ${this.scanMode === "in" ? "bg-emerald-50 text-emerald-700 border-b-4 border-emerald-500" : "text-slate-400 hover:bg-slate-50"}">
                                    <i data-lucide="package-plus" class="w-8 h-8"></i>
                                    <span class="font-bold uppercase tracking-wide">Entrada (F5)</span>
                                </button>
                                <button onclick="app.setScanMode('out')" class="flex-1 py-6 flex flex-col items-center justify-center gap-2 transition-colors ${this.scanMode === "out" ? "bg-red-50 text-red-700 border-b-4 border-red-500" : "text-slate-400 hover:bg-slate-50"}">
                                    <i data-lucide="package-minus" class="w-8 h-8"></i>
                                    <span class="font-bold uppercase tracking-wide">Saída (F6)</span>
                                </button>
                            </div>

                            <div class="p-8 md:p-12 text-center bg-slate-50/30">
                                <div class="relative max-w-lg mx-auto">
                                    <div class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400">
                                        <i data-lucide="scan-barcode" class="w-6 h-6"></i>
                                    </div>
                                    <form onsubmit="app.handleScanSubmit(event)">
                                        <input id="scannerInput" type="text" autocomplete="off"
                                            class="w-full pl-12 pr-4 py-5 text-2xl font-mono text-center rounded-2xl border-2 outline-none transition-all shadow-sm
                                            ${this.scanMode === "in" ? "border-emerald-200 focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500/10" : "border-red-200 focus:border-red-500 focus:ring-4 focus:ring-red-500/10"}"
                                            placeholder="Aguardando leitura..."
                                        >
                                    </form>
                                    <div class="mt-6 flex justify-center gap-3">
                                        <button onclick="app.openCameraScanner()" class="flex items-center gap-2 bg-slate-800 text-white px-5 py-2.5 rounded-xl font-medium shadow-lg hover:bg-slate-700 transition-all active:scale-95">
                                            <i data-lucide="camera" class="w-4 h-4"></i>
                                            Usar Câmera
                                        </button>
                                    </div>
                                    <p class="mt-4 text-sm text-slate-400 font-medium">Use um leitor USB ou a câmera do celular.</p>
                                </div>
                            </div>

                            <div id="scan-feedback" class="p-6 min-h-[160px] flex items-center justify-center bg-white border-t border-slate-100">
                                <p class="text-slate-400 italic">O último item processado aparecerá aqui.</p>
                            </div>
                        </div>

                        <div class="text-center mt-8">
                            <button onclick="app.simulateScan()" class="text-slate-400 hover:text-primary text-sm font-medium underline decoration-dashed underline-offset-4 transition-colors">
                                Sem leitor? Simular leitura aleatória
                            </button>
                        </div>
                    </div>
                `;
          setTimeout(() => this.focusScanner(), 100);
        }

        setScanMode(mode) {
          this.scanMode = mode;
          this.renderScanner(document.getElementById("app-content"));
        }

        focusScanner() {
          const input = document.getElementById("scannerInput");
          if (input) {
            input.focus();
            input.onblur = () => {
              if (
                this.activeTab === "scanner" &&
                !document
                  .getElementById("modal-camera")
                  .classList.contains("flex")
              ) {
                // Só refoca se a câmera não estiver aberta
                setTimeout(() => input.focus(), 500);
              }
            };
          }
        }

        handleScanSubmit(e) {
          e.preventDefault();
          const input = document.getElementById("scannerInput");
          const code = input.value.trim();
          if (!code) return;

          const item = this.inventory.find((i) => i.barcode === code);
          const feedbackEl = document.getElementById("scan-feedback");

          if (item) {
            if (this.scanMode === "in") {
              item.quantity++;
              this.logTransaction("entrada", item.name, 1, item.barcode);
              this.showToast(`+1 ${item.name}`, "success");
              this.renderScanSuccess(item, feedbackEl, "Adicionado");
            } else {
              if (item.quantity > 0) {
                item.quantity--;
                this.logTransaction("saida", item.name, 1, item.barcode);
                this.showToast(`-1 ${item.name}`, "warning");
                this.renderScanSuccess(item, feedbackEl, "Removido");
              } else {
                this.showToast(`Estoque vazio: ${item.name}`, "error");
                feedbackEl.innerHTML = `
                                <div class="text-center text-red-600 animate-pulse">
                                    <i data-lucide="x-circle" class="w-10 h-10 mx-auto mb-2"></i>
                                    <h3 class="font-bold text-lg">Estoque Insuficiente!</h3>
                                    <p>O produto "${item.name}" está zerado.</p>
                                </div>
                            `;
                lucide.createIcons();
                input.value = "";
                return;
              }
            }
            this.saveData();
          } else {
            this.showToast(`Código ${code} desconhecido`, "error");
            feedbackEl.innerHTML = `
                        <div class="text-center">
                            <div class="bg-slate-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-3">
                                <span class="text-xl font-mono font-bold text-slate-500">?</span>
                            </div>
                            <h3 class="font-bold text-lg text-slate-800">Produto não encontrado</h3>
                            <p class="text-slate-500 mb-4">O código <span class="font-mono bg-slate-100 px-1 rounded">${code}</span> não existe.</p>
                            <button onclick="app.openAddModal('${code}')" class="bg-primary text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg shadow-primary/30 hover:bg-indigo-700 transition-all">
                                Cadastrar Agora
                            </button>
                        </div>
                    `;
          }
          input.value = "";
        }

        renderScanSuccess(item, container, actionLabel) {
          const colorClass =
            this.scanMode === "in" ? "text-emerald-600" : "text-red-600";
          container.innerHTML = `
                    <div class="flex items-center w-full max-w-md animate-fade-in bg-slate-50 rounded-xl border border-slate-100 p-4">
                        <div class="flex-1">
                            <p class="text-xs text-slate-500 font-bold uppercase tracking-wider mb-1">${actionLabel} com sucesso</p>
                            <h3 class="font-bold text-xl text-slate-900 leading-tight">${item.name}</h3>
                            <p class="font-mono text-sm text-slate-400 mt-1">${item.barcode}</p>
                        </div>
                        <div class="text-right pl-4 border-l border-slate-200">
                            <p class="text-xs text-slate-500">Saldo Atual</p>
                            <p class="text-3xl font-bold ${item.quantity <= item.minStock ? "text-red-500" : "text-slate-800"}">${item.quantity}</p>
                        </div>
                    </div>
                `;
        }

        simulateScan() {
          if (this.inventory.length === 0)
            return this.showToast("Sem produtos para simular.", "error");
          const randomItem =
            this.inventory[Math.floor(Math.random() * this.inventory.length)];
          const input = document.getElementById("scannerInput");
          if (input) {
            input.value = randomItem.barcode;
            input.form.dispatchEvent(new Event("submit", { cancelable: true }));
          }
        }

        // --- Lógica da Câmera ---
        openCameraScanner() {
          this.cameraTargetInput = document.getElementById("scannerInput");
          this.startCamera();
        }

        openCameraForInput() {
          this.cameraTargetInput = document.getElementById("new-barcode");
          this.startCamera();
        }

        startCamera() {
          const modal = document.getElementById("modal-camera");
          modal.classList.remove("hidden");
          modal.classList.add("flex");

          // Inicializa apenas se não existir
          if (!this.html5QrcodeScanner) {
            // Configuração CRÍTICA: Definir formatos de código de barras suportados
            // Sem isso, ele pode ignorar códigos de produtos comuns (EAN-13)
            const formatsToSupport = [
              Html5QrcodeSupportedFormats.QR_CODE,
              Html5QrcodeSupportedFormats.EAN_13, // Padrão Brasil/Europa
              Html5QrcodeSupportedFormats.EAN_8,
              Html5QrcodeSupportedFormats.CODE_128, // Logística
              Html5QrcodeSupportedFormats.CODE_39,
              Html5QrcodeSupportedFormats.UPC_A, // Padrão EUA
              Html5QrcodeSupportedFormats.UPC_E,
              Html5QrcodeSupportedFormats.CODABAR,
              Html5QrcodeSupportedFormats.ITF,
            ];

            // verbose: false para limpar o console
            this.html5QrcodeScanner = new Html5Qrcode("reader", {
              formatsToSupport: formatsToSupport,
              verbose: false,
            });
          }

          // Configuração de escaneamento
          const config = {
            fps: 15, // Aumentado para 15 para leitura mais fluida
            qrbox: { width: 280, height: 180 }, // Retangular é melhor para códigos de barras longos
            aspectRatio: 1.0,
            disableFlip: false, // Importante para algumas câmeras frontais/traseiras
          };

          this.html5QrcodeScanner
            .start(
              { facingMode: "environment" }, // Tenta usar câmera traseira
              config,
              (decodedText) => {
                // Sucesso na leitura
                this.stopCamera();

                // Toca um som de "bip" para feedback
                this.playBeep();

                if (this.cameraTargetInput) {
                  this.cameraTargetInput.value = decodedText;

                  // Se for o scanner principal, submete automaticamente
                  if (this.cameraTargetInput.id === "scannerInput") {
                    this.handleScanSubmit({ preventDefault: () => {} });
                  } else {
                    // Se for no modal, apenas foca no próximo campo
                    document.getElementById("new-name")?.focus();
                  }
                }
              },
              (errorMessage) => {
                // Ignora erros de frame vazio para não spamar
              },
            )
            .catch((err) => {
              console.error(err);
              alert(
                "Erro ao acessar câmera. Verifique se deu permissão e se está usando HTTPS.",
              );
              this.stopCamera();
            });
        }

        stopCamera() {
          const modal = document.getElementById("modal-camera");
          modal.classList.add("hidden");
          modal.classList.remove("flex");

          if (this.html5QrcodeScanner && this.html5QrcodeScanner.isScanning) {
            this.html5QrcodeScanner
              .stop()
              .then(() => {
                // Limpeza interna se necessário
              })
              .catch((err) => console.log("Erro ao parar câmera:", err));
          }
        }

        // Função auxiliar de som
        playBeep() {
          // Tenta criar um contexto de áudio simples para um bip
          try {
            const AudioContext =
              window.AudioContext || window.webkitAudioContext;
            if (AudioContext) {
              const ctx = new AudioContext();
              const osc = ctx.createOscillator();
              const gain = ctx.createGain();

              osc.connect(gain);
              gain.connect(ctx.destination);

              osc.type = "sine";
              osc.frequency.value = 880; // Frequência A5
              gain.gain.value = 0.1;

              osc.start();
              setTimeout(() => osc.stop(), 100);
            }
          } catch (e) {
            console.error("Audio beep falhou", e);
          }
        }

        // --- Inventário ---
        renderInventory(container) {
          const filtered = this.inventory.filter(
            (item) =>
              item.name.toLowerCase().includes(this.searchTerm.toLowerCase()) ||
              item.barcode.includes(this.searchTerm) ||
              item.category
                .toLowerCase()
                .includes(this.searchTerm.toLowerCase()),
          );

          container.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-[calc(100vh-140px)] md:h-auto">
                        <div class="p-4 md:p-6 border-b border-slate-100 flex flex-col md:flex-row gap-4 justify-between items-center bg-white sticky top-0 z-10">
                            <div class="relative w-full md:w-96">
                                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"></i>
                                <input type="text" 
                                    placeholder="Buscar por nome, SKU ou categoria..." 
                                    value="${this.searchTerm}"
                                    oninput="app.handleSearch(this.value)"
                                    class="w-full pl-10 pr-4 py-2.5 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all bg-slate-50 focus:bg-white"
                                >
                            </div>
                            <button onclick="app.toggleModal(true)" class="w-full md:w-auto bg-primary text-white px-6 py-2.5 rounded-xl font-medium shadow-lg shadow-primary/20 hover:bg-indigo-700 hover:shadow-primary/40 transition-all flex items-center justify-center gap-2">
                                <i data-lucide="plus" class="w-5 h-5"></i>
                                Novo Produto
                            </button>
                        </div>
                        <div class="overflow-auto custom-scroll flex-1">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-slate-50 sticky top-0 z-0">
                                    <tr>
                                        <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider">Produto</th>
                                        <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider">Categoria</th>
                                        <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider text-right">Preço</th>
                                        <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider text-center">Status</th>
                                        <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider text-right">Ações</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    ${filtered
                                      .map(
                                        (item) => `
                                        <tr class="group hover:bg-slate-50 transition-colors">
                                            <td class="px-6 py-4">
                                                <div class="flex flex-col">
                                                    <span class="font-bold text-slate-800">${item.name}</span>
                                                    <span class="text-xs font-mono text-slate-400 flex items-center gap-1">
                                                        <i data-lucide="barcode" class="w-3 h-3"></i> ${item.barcode}
                                                    </span>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4">
                                                <span class="px-2.5 py-1 rounded-lg bg-slate-100 text-slate-600 text-xs font-medium border border-slate-200">
                                                    ${item.category}
                                                </span>
                                            </td>
                                            <td class="px-6 py-4 text-right font-medium text-slate-600">
                                                ${this.formatCurrency(item.price)}
                                            </td>
                                            <td class="px-6 py-4 text-center">
                                                <div class="flex flex-col items-center">
                                                    <span class="text-lg font-bold ${item.quantity <= item.minStock ? "text-red-600" : "text-slate-800"}">
                                                        ${item.quantity}
                                                    </span>
                                                    ${
                                                      item.quantity <=
                                                      item.minStock
                                                        ? '<span class="text-[10px] font-bold text-red-500 uppercase bg-red-50 px-2 rounded-full border border-red-100">Repor</span>'
                                                        : '<span class="text-[10px] text-emerald-600 font-medium">OK</span>'
                                                    }
                                                </div>
                                            </td>
                                            <td class="px-6 py-4 text-right">
                                                <div class="flex justify-end gap-2">
                                                    <button onclick="app.openEditModal(${item.id})" class="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="Editar">
                                                        <i data-lucide="pencil" class="w-5 h-5"></i>
                                                    </button>
                                                    <button onclick="app.deleteItem(${item.id})" class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Excluir">
                                                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `,
                                      )
                                      .join("")}
                                </tbody>
                            </table>
                            ${
                              filtered.length === 0
                                ? `
                                <div class="flex flex-col items-center justify-center py-16 text-slate-400">
                                    <i data-lucide="package-search" class="w-16 h-16 mb-4 opacity-50"></i>
                                    <p class="text-lg font-medium">Nenhum produto encontrado</p>
                                    <p class="text-sm">Tente buscar outro termo ou adicione um novo.</p>
                                </div>
                            `
                                : ""
                            }
                        </div>
                    </div>
                `;
        }

        handleSearch(val) {
          this.searchTerm = val;
          this.renderInventory(document.getElementById("app-content"));
          lucide.createIcons();
        }

        // --- Lógica de CRUD (Criar, Editar, Excluir) ---
        toggleModal(show) {
          const modal = document.getElementById("modal-add");
          const content = document.getElementById("modal-content");
          const form = document.getElementById("form-add");

          if (show) {
            modal.classList.remove("hidden");
            modal.classList.add("flex");
            setTimeout(() => {
              content.classList.remove("scale-95", "opacity-0");
              content.classList.add("scale-100", "opacity-100");
            }, 10);
          } else {
            content.classList.remove("scale-100", "opacity-100");
            content.classList.add("scale-95", "opacity-0");
            setTimeout(() => {
              modal.classList.add("hidden");
              modal.classList.remove("flex");
              form.reset();
              this.editingId = null;
              document.getElementById("modal-title").textContent =
                "Novo Produto";
            }, 200);
          }
        }

        openAddModal(barcode = "") {
          this.toggleModal(true);
          if (barcode) document.getElementById("new-barcode").value = barcode;
        }

        openEditModal(id) {
          const item = this.inventory.find((i) => i.id === id);
          if (!item) return;

          this.editingId = id;
          document.getElementById("modal-title").textContent = "Editar Produto";
          document.getElementById("new-barcode").value = item.barcode;
          document.getElementById("new-name").value = item.name;
          document.getElementById("new-category").value = item.category;
          document.getElementById("new-price").value = item.price;
          document.getElementById("new-quantity").value = item.quantity;
          document.getElementById("new-minStock").value = item.minStock;

          this.toggleModal(true);
        }

        generateRandomBarcode() {
          const random = Math.floor(
            7890000000000 + Math.random() * 999999999,
          ).toString();
          document.getElementById("new-barcode").value = random;
        }

        handleSaveItem(e) {
          e.preventDefault();
          const barcode = document.getElementById("new-barcode").value.trim();
          const name = document.getElementById("new-name").value;
          const category = document.getElementById("new-category").value;
          const price = parseFloat(document.getElementById("new-price").value);
          const quantity = parseInt(
            document.getElementById("new-quantity").value,
          );
          const minStock = parseInt(
            document.getElementById("new-minStock").value,
          );

          if (this.editingId) {
            const index = this.inventory.findIndex(
              (i) => i.id === this.editingId,
            );
            if (index > -1) {
              if (
                this.inventory.some(
                  (i) => i.barcode === barcode && i.id !== this.editingId,
                )
              ) {
                this.showToast(
                  "Este código de barras já pertence a outro produto!",
                  "error",
                );
                return;
              }

              const oldQty = this.inventory[index].quantity;
              this.inventory[index] = {
                ...this.inventory[index],
                barcode,
                name,
                category,
                price,
                quantity,
                minStock,
              };
              if (oldQty !== quantity) {
                const diff = quantity - oldQty;
                this.logTransaction("ajuste", name, Math.abs(diff), barcode);
              }
              this.showToast("Produto atualizado com sucesso!", "success");
            }
          } else {
            if (this.inventory.some((i) => i.barcode === barcode)) {
              this.showToast("Este código de barras já existe!", "error");
              return;
            }

            const newItem = {
              id: Date.now(),
              barcode,
              name,
              category,
              price,
              quantity,
              minStock,
            };
            this.inventory.push(newItem);
            this.logTransaction(
              "novo",
              newItem.name,
              newItem.quantity,
              newItem.barcode,
            );
            this.showToast("Produto cadastrado com sucesso!", "success");
          }

          this.saveData();
          this.toggleModal(false);

          if (this.activeTab === "inventory") {
            this.render();
          } else if (this.activeTab === "scanner" && !this.editingId) {
            this.setScanMode("in");
          }
        }

        deleteItem(id) {
          if (
            confirm(
              "Tem certeza que deseja remover este produto permanentemente?",
            )
          ) {
            const index = this.inventory.findIndex((i) => i.id === id);
            if (index > -1) {
              const item = this.inventory[index];
              this.inventory.splice(index, 1);
              this.logTransaction("removido", item.name, 0, item.barcode);
              this.saveData();
              this.render();
              this.showToast("Produto removido.", "success");
            }
          }
        }

        logTransaction(action, itemName, quantity, barcode) {
          this.logs.unshift({
            id: Date.now(),
            date: new Date().toLocaleDateString("pt-BR"),
            time: new Date().toLocaleTimeString("pt-BR", {
              hour: "2-digit",
              minute: "2-digit",
            }),
            action,
            itemName,
            quantity,
            barcode,
          });
          this.saveData();
        }

        showToast(message, type = "success") {
          const container = document.getElementById("toast-container");
          const toast = document.createElement("div");
          const styles = {
            success: "bg-emerald-600 text-white",
            error: "bg-red-600 text-white",
            warning: "bg-amber-500 text-white",
          };
          const icons = {
            success: "check-circle",
            error: "alert-circle",
            warning: "alert-triangle",
          };
          toast.className = `${styles[type]} px-6 py-4 rounded-xl shadow-xl flex items-center gap-3 min-w-[300px] toast-enter pointer-events-auto`;
          toast.innerHTML = `
                    <i data-lucide="${icons[type]}" class="w-5 h-5"></i>
                    <span class="font-medium">${message}</span>
                `;
          container.appendChild(toast);
          lucide.createIcons();
          setTimeout(() => {
            toast.style.opacity = "0";
            toast.style.transform = "translateY(-10px)";
            toast.style.transition = "all 0.3s";
            setTimeout(() => toast.remove(), 300);
          }, 3000);
        }

        formatCurrency(value) {
          return new Intl.NumberFormat("pt-BR", {
            style: "currency",
            currency: "BRL",
          }).format(value);
        }

        exportCSV() {
          let csvContent = "data:text/csv;charset=utf-8,";
          csvContent += "ID,Nome,Codigo,Categoria,Preco,Estoque,Minimo\n";
          this.inventory.forEach((item) => {
            const row = `${item.id},"${item.name}",${item.barcode},${item.category},${item.price},${item.quantity},${item.minStock}`;
            csvContent += row + "\n";
          });
          const encodedUri = encodeURI(csvContent);
          const link = document.createElement("a");
          link.setAttribute("href", encodedUri);
          link.setAttribute("download", "estoque_stockflow.csv");
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
      }

      const app = new StockSystem();
      document.addEventListener("DOMContentLoaded", () => {
        app.init();
        document
          .getElementById("form-add")
          .addEventListener("submit", app.handleSaveItem);
      });
    </script>
  </body>
</html>
